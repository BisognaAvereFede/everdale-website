<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Everdale ‚Äì News Editor</title>

  <!-- Icons & Fonts -->
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-bold-rounded/css/uicons-bold-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-brands/css/uicons-brands.css">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Paytone+One&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html{scroll-behavior:smooth}
    body{font-family:'Paytone One',sans-serif}
    .sys-sans{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji'}
    /* Simple content styles for editor's markdown textarea preview */
    .prose :where(p,li){font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';font-weight:500}
    .prose :where(h2,h3){font-family:'Paytone One',sans-serif}
  </style>
</head>
<body class="min-h-screen bg-[#1E1B18] text-[#F9EBD0]">
  <!-- Topbar -->
  <header class="sticky top-0 z-50 bg-[#1E1B18]/95 backdrop-blur border-b border-white/10">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div class="h-9 w-9 grid place-items-center rounded-2xl border border-[#F9EBD0]/40">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 7l5 3 5-7 5 7 5-3v13H2z"/>
        </svg>
      </div>
      <div class="text-lg font-extrabold tracking-tight">Everdale ‚Äì News Editor</div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btn-load" class="rounded-xl border border-white/20 px-3 py-1.5 text-sm hover:bg-white/5">Carica JSON</button>
        <button id="btn-save" class="rounded-xl border border-white/20 px-3 py-1.5 text-sm hover:bg-white/5">Salva JSON</button>
        <button id="btn-copy" class="rounded-xl bg-amber-600 text-white px-3 py-1.5 text-sm hover:bg-amber-500">Copia HTML</button>
        <button id="btn-download" class="rounded-xl bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-500">Scarica HTML</button>
        <button id="btn-tests" class="rounded-xl border border-white/20 px-3 py-1.5 text-sm hover:bg-white/5">Esegui test</button>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <div class="mx-auto max-w-7xl px-4 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- FORM -->
    <section class="rounded-3xl bg-[#2B2723] border border-white/10 p-5">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-xl font-extrabold">Impostazioni articolo</h2>
        <button id="btn-reset" class="rounded-xl px-3 py-1.5 text-sm border border-white/20 hover:bg-white/5">Reset</button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Titolo</span>
          <input id="title" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="Hello üëã" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Categoria (badge)</span>
          <input id="category" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="NEWS" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Data</span>
          <input id="date" type="date" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Ritorna a (URL)</span>
          <input id="backUrl" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="/news" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Autore ‚Äì Nome</span>
          <input id="authorName" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="Pau101" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Autore ‚Äì Ruolo</span>
          <input id="authorRole" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="Engineer ‚Äî Everdale" />
        </label>
        <label class="block">
          <span class="sys-sans text-sm text-[#DCCFB4]">Autore ‚Äì Avatar URL</span>
          <input id="authorAvatar" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="/images/avatars/pau.png" />
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="sys-sans text-sm text-[#DCCFB4]">Prev ‚Äì Titolo</span>
            <input id="prevTitle" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="Nuovi Minigame üéÆ" />
          </label>
          <label class="block">
            <span class="sys-sans text-sm text-[#DCCFB4]">Prev ‚Äì URL</span>
            <input id="prevUrl" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="/news/minigames" />
          </label>
          <label class="block">
            <span class="sys-sans text-sm text-[#DCCFB4]">Next ‚Äì Titolo</span>
            <input id="nextTitle" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="Evento Estivo ‚òÄÔ∏è" />
          </label>
          <label class="block">
            <span class="sys-sans text-sm text-[#DCCFB4]">Next ‚Äì URL</span>
            <input id="nextUrl" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="/news/estate" />
          </label>
        </div>
        <label class="block md:col-span-2">
          <span class="sys-sans text-sm text-[#DCCFB4]">Cover ‚Äì URL</span>
          <input id="coverUrl" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="./images/news_test.png" />
        </label>
        <label class="block md:col-span-2">
          <span class="sys-sans text-sm text-[#DCCFB4]">Cover ‚Äì File (opzionale)</span>
          <input id="coverFile" type="file" accept="image/*" class="mt-1 w-full rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" />
        </label>
        <label class="block md:col-span-2">
          <span class="sys-sans text-sm text-[#DCCFB4]">Articolo (Markdown o HTML)</span>
          <textarea id="body" class="mt-1 w-full h-64 rounded-xl bg-[#1F1B18] border border-white/10 px-3 py-2 sys-sans" placeholder="# Titolo sezione\nParagrafo lungo..."></textarea>
        </label>
      </div>
    </section>

    <!-- PREVIEW -->
    <section class="rounded-3xl bg-[#2B2723] border border-white/10 overflow-hidden">
      <iframe id="preview" class="w-full h-[calc(100vh-12rem)] bg-[#2B2723]"></iframe>
    </section>
  </div>

  <!-- FOOTER -->
  <footer class="border-t border-white/10">
    <div class="mx-auto max-w-7xl px-4 py-6 text-sm text-[#DCCFB4]/80 flex items-center justify-between">
      <div>Tip: compila i campi a sinistra; la preview si aggiorna in tempo reale.</div>
      <div class="flex items-center gap-4">
        <label class="flex items-center gap-2"><input id="opt-minify" type="checkbox" class="accent-emerald-500"> Minifica HTML</label>
        <label class="flex items-center gap-2"><input id="opt-open" type="checkbox" class="accent-emerald-500"> Apri in nuova scheda al download</label>
      </div>
    </div>
  </footer>

  <!-- Toast test -->
  <div id="test-toast" class="fixed bottom-4 right-4 hidden rounded-xl bg-[#2B2723] border border-white/10 px-4 py-3 text-sm shadow"></div>

<script>
// --- Helpers ---
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const state = {};

function toItalianDate(iso){
  if(!iso) return '';
  try {
    const d = new Date(iso);
    return d.toLocaleDateString('it-IT', { day:'2-digit', month:'long', year:'numeric' });
  } catch { return iso; }
}

function simpleMarkdown(md){
  if(!md) return '';
  // Escape basic HTML, then allow explicit HTML by reverting common tags later
  let s = md
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // Allow explicit HTML blocks if user already wrote HTML
  if(/<\s*(h\d|p|ul|ol|li|div|span|strong|em|b|i|img|a)[^>]*>/i.test(md)){
    return md; // trust user-provided HTML
  }
  // Headings ## and ### (keep # for h1 out of body)
  s = s.replace(/^###\s?(.+)$/gm, '<h3>$1</h3>');
  s = s.replace(/^##\s?(.+)$/gm, '<h2>$1</h2>');
  // Bold/italic
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Lists
  s = s.replace(/^(?:-\s.+\n?)+/gm, m => {
    const items = m.trim().split(/\n/).map(li=>li.replace(/^-\s?/,''));
    return '<ul>' + items.map(it=>`<li>${it}</li>`).join('') + '</ul>';
  });
  // Paragraphs
  s = s.split(/\n{2,}/).map(block=>/^(<h\d|<ul|<ol|<img|<blockquote|<div)/.test(block)?block:`<p>${block.replace(/\n/g,'<br>')}</p>`).join('\n');
  return s;
}

function computeReadingMins(html){
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const txt = tmp.innerText || '';
  const words = (txt.trim().match(/\S+/g) || []).length;
  return Math.max(1, Math.round(words/200));
}

function minifyHTML(html){
  return html
    .replace(/>\s+</g,'><')
    .replace(/\n+/g,'\n')
    .replace(/\s{2,}/g,' ')
}

// --- Template generator (matches your article page) ---
function buildArticleHTML(data){
  const {
    title, category, date, coverSrc, bodyHTML,
    authorName, authorRole, authorAvatar,
    prevTitle, prevUrl, nextTitle, nextUrl,
    backUrl
  } = data;

  const mins = computeReadingMins(bodyHTML);

  // IMPORTANT: escape </script> inside the template to avoid prematurely ending this outer <script>
  return `<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${title ? title.replace(/\"/g,'&quot;') : 'Everdale - News'}</title>
  <meta name="description" content="Aggiornamento dall‚Äôisola: eventi, QoL e anteprime." />
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-bold-rounded/css/uicons-bold-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-brands/css/uicons-brands.css">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Paytone+One&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"><\/script>
  <style>
    html{scroll-behavior:smooth;font-size:150%}
    body{font-family:'Paytone One',sans-serif}
    @media (max-width:1024px){html{font-size:125%}}
    @media (max-width:640px){html{font-size:112.5%}}
  </style>
</head>
<body class="min-h-screen bg-[#2B2723] text-[#F9EBD0]">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-[#2B2723]/95 backdrop-blur border-b border-white/10">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 text-[#F9EBD0]">
        <div class="h-9 w-9 grid place-items-center rounded-2xl border border-[#F9EBD0]/40">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 7l5 3 5-7 5 7 5-3v13H2z"/>
          </svg>
        </div>
        <span class="font-extrabold tracking-tight text-lg">EVERDALE</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm text-[#F9EBD0]/90">
        <a href="/#features" class="hover:opacity-80">Modalit√†</a>
        <a href="/#welcome" class="hover:opacity-80">Welcome</a>
        <a href="/news" class="hover:opacity-80">News</a>
      </nav>
      <a href="#join" class="rounded-2xl bg-amber-600 text-white px-4 py-2 text-sm">Discord</a>
    </div>
  </header>

  <!-- Hero articolo -->
  <section class="relative overflow-hidden">
    <div class="relative mx-auto max-w-3xl px-4 py-14 text-center">
      <div class="inline-flex items-center gap-2">
        <a href="${backUrl || '/news'}" class="text-amber-400 hover:text-amber-300 text-sm"> <i class="fi fi-sc-left"></i> Torna alle news</a>
      </div>

      <h1 class="mt-3 text-4xl md:text-5xl font-extrabold tracking-tight">${title || 'Titolo'}</h1>

      <div class="mt-4 flex items-center justify-center gap-3 text-sm text-[#DCCFB4]/80">
        ${category?`<span class=\"inline-flex items-center rounded-lg bg-red-600 text-white px-3 py-1 text-[11px]\">${category}</span>`:''}
        <time>${toItalianDate(date)||''}</time>
        <span>¬∑ ${mins} min</span>
      </div>

      <div class="mt-8 rounded-3xl overflow-hidden shadow-lg border border-white/10">
        <img src="${coverSrc || ''}" alt="Cover" class="w-full h-auto object-cover">
      </div>
    </div>
  </section>

  <!-- Corpo articolo -->
  <main class="relative">
  <article class="relative mx-auto max-w-3xl px-4 py-12 prose prose-invert prose-headings:font-extrabold">
    <style>
      .prose :where(p,li){font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';font-weight:500}
      .prose :where(h2,h3){font-family:'Paytone One',sans-serif}
    </style>
    ${bodyHTML || ''}

    <div class="not-prose mt-10 flex flex-wrap items-center gap-3">
      <button id="share" class="rounded-2xl bg-amber-600 text-white px-4 py-2 text-sm shadow hover:bg-amber-500 transition">Condividi questa notizia</button>
      <a href="${backUrl || '/news'}" class="rounded-2xl border border-white/20 px-4 py-2 text-sm">Torna alla bacheca</a>
    </div>

    <hr class="my-10 border-white/20">

    <div class="not-prose flex items-center gap-3">
      <img src="${authorAvatar || '/images/avatars/pau.png'}" alt="Autore" class="w-10 h-10 rounded-xl border border-white/20">
      <div>
        <div class="font-extrabold">${authorName || 'Autore'}</div>
        <div class="text-[#DCCFB4]/80 text-sm">${authorRole || ''}</div>
      </div>
    </div>
  </article>

    <nav class="mx-auto max-w-3xl px-4 pb-16">
      <div class="flex flex-col md:flex-row gap-4 md:gap-6">
        ${nextUrl?`<a href=\"${nextUrl}\" class=\"flex-1 rounded-2xl bg-[#1F1B18] border border-white/10 px-4 py-4 shadow hover:bg-[#26221f] transition\"><div class=\"text-xs text-[#DCCFB4]/70\">Articolo successivo</div><div class=\"mt-1 font-extrabold\">${nextTitle||''}</div></a>`:''}
        ${prevUrl?`<a href=\"${prevUrl}\" class=\"flex-1 rounded-2xl bg-[#1F1B18] border border-white/10 px-4 py-4 shadow hover:bg-[#26221f] transition\"><div class=\"text-xs text-[#DCCFB4]/70\">Articolo precedente</div><div class=\"mt-1 font-extrabold\">${prevTitle||''}</div></a>`:''}
      </div>
    </nav>
  </main>

  <!-- FOOTER -->
  <footer class="bg-[#2B2723] text-[#F9EBD0]">
    <div class="mx-auto max-w-6xl px-4 py-10 flex flex-col md:flex-row items-center justify-between gap-6">
      <div class="flex items-center gap-3">
        <img src="images/pine_badge.png" alt="Logo" class="h-10 w-auto drop-shadow">
        <div>
          <div class="font-extrabold text-lg">everdale.it</div>
          <div class="text-sm text-amber-400">Coming soon</div>
        </div>
      </div>
      <div class="flex items-center gap-4 text-2xl">
        <a href="https://discord.gg/tuo-invito" class="hover:opacity-80 text-[#5865F2]"><i class="fi fi-brands-discord"></i></a>
        <a href="#" class="hover:opacity-80 text-[#1DA1F2]"><i class="fi fi-brands-twitter"></i></a>
        <a href="#" class="hover:opacity-80 text-[#000000]"><i class="fi fi-brands-tik-tok"></i></a>
        <a href="#" class="hover:opacity-80 text-[#E1306C]"><i class="fi fi-brands-instagram"></i></a>
        <a href="#" class="hover:opacity-80 text-[#FF0000]"><i class="fi fi-brands-youtube"></i></a>
      </div>
    </div>
    <div class="border-t border-white/10"></div>
    <div class="mx-auto max-w-6xl px-4 py-6 text-sm flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="text-center md:text-left text-[#DCCFB4]/80">¬© <span id="year"></span> EVERDALE. Tutti i diritti riservati. Non affiliato con Mojang AB.</div>
      <nav class="flex flex-wrap justify-center md:justify-end gap-5 font-semibold text-sm text-[#F9EBD0]">
        <a href="/rules" class="hover:underline">Rules</a>
        <a href="/terms" class="hover:underline">Terms</a>
        <a href="/privacy" class="hover:underline">Privacy</a>
        <a href="/credits" class="hover:underline">Credits</a>
        <a href="#top" class="flex items-center gap-1 hover:underline"><i class="fi fi-sr-angle-up"></i> Top</a>
      </nav>
    </div>
  </footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  (function(){
    const btn = document.getElementById('share');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      const data = {title: document.title, text:"Dai un‚Äôocchiata a questa notizia di Everdale!", url:location.href};
      if (navigator.share) {
        try { await navigator.share(data); } catch(_) {}
      } else {
        try { await navigator.clipboard.writeText(location.href); btn.textContent="Link copiato!"; setTimeout(()=>btn.textContent="Condividi questa notizia",1500);} catch(_) {}
      }
    });
  })();
<\/script>
</body>
</html>`;
}

// --- I/O ---
function updateState(){
  state.title = $('#title').value.trim();
  state.category = $('#category').value.trim();
  state.date = $('#date').value;
  state.backUrl = $('#backUrl').value.trim();
  state.authorName = $('#authorName').value.trim();
  state.authorRole = $('#authorRole').value.trim();
  state.authorAvatar = $('#authorAvatar').value.trim();
  state.prevTitle = $('#prevTitle').value.trim();
  state.prevUrl = $('#prevUrl').value.trim();
  state.nextTitle = $('#nextTitle').value.trim();
  state.nextUrl = $('#nextUrl').value.trim();
  state.coverUrl = $('#coverUrl').value.trim();
  state.body = $('#body').value;
}

let coverDataUrl = '';
$('#coverFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return; const r = new FileReader();
  r.onload = () => { coverDataUrl = r.result; render(); };
  r.readAsDataURL(f);
});

function render(){
  updateState();
  const coverSrc = coverDataUrl || state.coverUrl;
  const bodyHTML = simpleMarkdown(state.body);
  const html = buildArticleHTML({
    title: state.title,
    category: state.category,
    date: state.date,
    coverSrc,
    bodyHTML,
    authorName: state.authorName,
    authorRole: state.authorRole,
    authorAvatar: state.authorAvatar,
    prevTitle: state.prevTitle,
    prevUrl: state.prevUrl,
    nextTitle: state.nextTitle,
    nextUrl: state.nextUrl,
    backUrl: state.backUrl,
  });
  const iframe = $('#preview');
  if ('srcdoc' in iframe) {
    iframe.srcdoc = html;
  } else {
    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(html); doc.close();
  }
}

$$('input, textarea').forEach(el=> el.addEventListener('input', render));

// Buttons
$('#btn-copy').addEventListener('click', async ()=>{
  updateState();
  const coverSrc = coverDataUrl || state.coverUrl;
  const bodyHTML = simpleMarkdown(state.body);
  let html = buildArticleHTML({ ...state, coverSrc, bodyHTML });
  if($('#opt-minify').checked) html = minifyHTML(html);
  try { await navigator.clipboard.writeText(html); $('#btn-copy').textContent = 'Copiato!'; setTimeout(()=>$('#btn-copy').textContent='Copia HTML',1200);} catch(e){ alert('Copia non riuscita'); }
});

$('#btn-download').addEventListener('click', ()=>{
  updateState();
  const coverSrc = coverDataUrl || state.coverUrl;
  const bodyHTML = simpleMarkdown(state.body);
  let html = buildArticleHTML({ ...state, coverSrc, bodyHTML });
  if($('#opt-minify').checked) html = minifyHTML(html);
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const slug = (state.title||'everdale-news').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  a.download = `${slug||'news'}.html`;
  a.href = url; a.click();
  if($('#opt-open').checked){ window.open(url, '_blank'); }
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
});

$('#btn-save').addEventListener('click', ()=>{
  updateState();
  const data = { ...state, coverDataUrl };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.download = 'everdale-news.json';
  a.href = URL.createObjectURL(blob); a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});

$('#btn-load').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const r = new FileReader(); r.onload = ()=>{
      try{
        const data = JSON.parse(r.result);
        $('#title').value = data.title||'';
        $('#category').value = data.category||'';
        $('#date').value = data.date||'';
        $('#backUrl').value = data.backUrl||'/news';
        $('#authorName').value = data.authorName||'';
        $('#authorRole').value = data.authorRole||'';
        $('#authorAvatar').value = data.authorAvatar||'';
        $('#prevTitle').value = data.prevTitle||'';
        $('#prevUrl').value = data.prevUrl||'';
        $('#nextTitle').value = data.nextTitle||'';
        $('#nextUrl').value = data.nextUrl||'';
        $('#coverUrl').value = data.coverUrl||'';
        $('#body').value = data.body||'';
        coverDataUrl = data.coverDataUrl||'';
        render();
      }catch(err){ alert('JSON non valido'); }
    };
    r.readAsText(f);
  };
  inp.click();
});

$('#btn-reset').addEventListener('click', ()=>{
  $$('#title, #category, #date, #backUrl, #authorName, #authorRole, #authorAvatar, #prevTitle, #prevUrl, #nextTitle, #nextUrl, #coverUrl').forEach(el=>el.value='');
  $('#body').value = '';
  coverDataUrl = '';
  render();
});

// --- Simple tests ---
function runTests(){
  const toast = $('#test-toast');
  const results = [];
  const test = (name, fn) => { try { fn(); results.push({name, pass:true}); } catch(e){ results.push({name, pass:false, err:e.message}); } };

  // Test 1: markdown to HTML
  test('Markdown heading + paragraph', ()=>{
    const html = simpleMarkdown('## Titolo\n\nParagrafo');
    if(!html.includes('<h2>Titolo</h2>')) throw new Error('h2 mancante');
    if(!html.includes('<p>Paragrafo</p>')) throw new Error('p mancante');
  });

  // Test 2: computeReadingMins on 400 parole ~ 2 min
  test('Lettura: 400 parole ‚âà 2 min', ()=>{
    const text = Array(400).fill('x').join(' ');
    const mins = computeReadingMins(`<p>${text}</p>`);
    if(mins !== 2) throw new Error('Atteso 2, ottenuto '+mins);
  });

  // Test 3: buildArticleHTML non deve contenere "</script>" grezzo
  test('Escaping </script> nel template', ()=>{
    const html = buildArticleHTML({title:'T',category:'C',date:'2025-09-19',coverSrc:'x',bodyHTML:'<p>a</p>'});
    if(/<\/script>/.test(html)) throw new Error('Contiene </script> non escapato');
    if(!/<\\\/script>/.test(html)) throw new Error('Manca <\\/script> escapato');
  });

  // Test 4: srcdoc support branch
  test('Preview usa srcdoc se disponibile', ()=>{
    const iframe = document.createElement('iframe');
    const has = ('srcdoc' in iframe);
    if(typeof has !== 'boolean') throw new Error('Check srcdoc fallito');
  });

  // Render results
  const pass = results.filter(r=>r.pass).length;
  const fail = results.length - pass;
  console.table(results);
  toast.textContent = `Test: ${pass} superati, ${fail} falliti` + (fail? ' ‚Äî vedi console per dettagli':' ‚úÖ');
  toast.classList.remove('hidden');
  setTimeout(()=>toast.classList.add('hidden'), 4000);
}

$('#btn-tests').addEventListener('click', runTests);

// Defaults
(function init(){
  $('#title').value = 'Hello üëã';
  $('#category').value = 'NEWS';
  $('#date').valueAsDate = new Date();
  $('#backUrl').value = '/news';
  $('#authorName').value = 'Pau101';
  $('#authorRole').value = 'Engineer ‚Äî Everdale';
  $('#authorAvatar').value = '/images/avatars/pau.png';
  $('#prevTitle').value = 'Nuovi Minigame üéÆ';
  $('#prevUrl').value = '/news/minigames';
  $('#nextTitle').value = 'Evento Estivo ‚òÄÔ∏è';
  $('#nextUrl').value = '/news/estate';
  $('#coverUrl').value = './images/news_test.png';
  $('#body').value = `## Eventi del weekend e attivit√† in arrivo\nLa prima grande novit√† riguarda il programma degli eventi del fine settimana...\n\n## Uno sguardo al futuro\nNelle prossime settimane arriveranno due nuovi minigame...\n\n## La forza della community\nEverdale non √® solo un server, ma un luogo...\n\n## Conclusione\nQuesto √® solo l'inizio di una lunga serie di aggiornamenti.`;
  render();
})();
</script>
</body>
</html>
